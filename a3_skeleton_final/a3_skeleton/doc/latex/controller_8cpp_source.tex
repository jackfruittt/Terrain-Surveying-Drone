\doxysection{controller.\+cpp}
\hypertarget{controller_8cpp_source}{}\label{controller_8cpp_source}\index{src/controller.cpp@{src/controller.cpp}}
\mbox{\hyperlink{controller_8cpp}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00001}00001\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{controller_8h}{controller.h}}"{}}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00002}00002\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00003}00003\ \textcolor{keyword}{using\ namespace\ }std::chrono\_literals;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00004}00004\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00005}\mbox{\hyperlink{class_controller_a3ee84c4beb2734e1e90382f2f9c1047b}{00005}}\ \mbox{\hyperlink{class_controller_a3ee84c4beb2734e1e90382f2f9c1047b}{Controller::Controller}}(}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00006}00006\ \ \ \ \ \textcolor{comment}{//\ Reveive\ publishers\ from\ drone\_node,\ ensuring\ controller\ focuses\ only\ on\ controlling\ and\ not\ doing\ any\ of\ the\ ROS\ work}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00007}00007\ \ \ \ \ \textcolor{keyword}{const}\ rclcpp::Publisher<geometry\_msgs::msg::Twist>::SharedPtr\ \&cmd\_vel\_pub,}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00008}00008\ \ \ \ \ \textcolor{keyword}{const}\ rclcpp::Publisher<std\_msgs::msg::Empty>::SharedPtr\ \&takeoff\_pub,}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00009}00009\ \ \ \ \ \textcolor{keyword}{const}\ rclcpp::Publisher<std\_msgs::msg::Empty>::SharedPtr\ \&land\_pub,}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00010}00010\ \ \ \ \ \textcolor{keyword}{const}\ rclcpp::Logger\ \&logger)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00011}00011\ \ \ \ \ :\ cmd\_vel\_pub\_(cmd\_vel\_pub),\ takeoff\_pub\_(takeoff\_pub),\ land\_pub\_(land\_pub),\ logger\_(logger),}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00012}00012\ \ \ \ \ \ \ has\_last\_waypoint\_(false)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00013}00013\ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00014}00014\ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00015}00015\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00016}00016\ \textcolor{comment}{//\ Process\ control\ commands\ for\ drone}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00017}\mbox{\hyperlink{class_controller_a6ba57da8b9aef7e4e894e903414e6383}{00017}}\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{class_controller_a6ba57da8b9aef7e4e894e903414e6383}{Controller::processCommand}}(\mbox{\hyperlink{struct_vehicle_data}{VehicleData}}\ \&vehicle,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{struct_vehicle_data_1_1_command}{VehicleData::Command}}\ \&command)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00018}00018\ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00019}00019\ \ \ \ \ \textcolor{keywordflow}{switch}\ (command.\mbox{\hyperlink{struct_vehicle_data_1_1_command_a852410ad54024f67d6fe779575e930a7}{type}})}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00020}00020\ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00021}00021\ \ \ \ \ \textcolor{keywordflow}{case}\ \mbox{\hyperlink{struct_vehicle_data_1_1_command_ad4da8b67775a3eb99887a5c052775581a8fabc74a4ed0781d663336cbf8c9c53d}{VehicleData::Command::Type::TAKEOFF}}:}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00022}00022\ \ \ \ \ \ \ \ \ RCLCPP\_INFO(logger\_,\ \textcolor{stringliteral}{"{}Processing\ TAKEOFF\ command\ for\ \%s"{}},\ vehicle.\mbox{\hyperlink{struct_vehicle_data_a5ecdf99bc0b878875df1289ad92d32f2}{id}}.c\_str());}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00023}00023\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{class_controller_a68cafe80a04b33fb2a6abd3ada2c6e47}{takeoff}}(vehicle);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00024}00024\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00025}00025\ \ \ \ \ \textcolor{keywordflow}{case}\ \mbox{\hyperlink{struct_vehicle_data_1_1_command_ad4da8b67775a3eb99887a5c052775581a7ab0a1cfd85cc3da16cd3e3ad7448524}{VehicleData::Command::Type::LANDING}}:}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00026}00026\ \ \ \ \ \ \ \ \ RCLCPP\_INFO(logger\_,\ \textcolor{stringliteral}{"{}Processing\ LAND\ command\ for\ \%s"{}},\ vehicle.\mbox{\hyperlink{struct_vehicle_data_a5ecdf99bc0b878875df1289ad92d32f2}{id}}.c\_str());}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00027}00027\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{class_controller_ad88269eeca9c75ba490895d693a08260}{land}}(vehicle);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00028}00028\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00029}00029\ \ \ \ \ \textcolor{keywordflow}{case}\ \mbox{\hyperlink{struct_vehicle_data_1_1_command_ad4da8b67775a3eb99887a5c052775581a0d19465986ce26eceefd63e055ccdeaa}{VehicleData::Command::Type::FLYING}}:}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00030}00030\ \ \ \ \ \ \ \ \ RCLCPP\_INFO(logger\_,\ \textcolor{stringliteral}{"{}Processing\ FLY\_TO\_GOAL\ command\ for\ \%s\ to\ [\%.2f,\ \%.2f,\ \%.2f]"{}},}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00031}00031\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ vehicle.\mbox{\hyperlink{struct_vehicle_data_a5ecdf99bc0b878875df1289ad92d32f2}{id}}.c\_str(),\ command.\mbox{\hyperlink{struct_vehicle_data_1_1_command_a535b4b5836f0c1f681e9742c3b540ba0}{goal}}.position.x,\ command.\mbox{\hyperlink{struct_vehicle_data_1_1_command_a535b4b5836f0c1f681e9742c3b540ba0}{goal}}.position.y,\ command.\mbox{\hyperlink{struct_vehicle_data_1_1_command_a535b4b5836f0c1f681e9742c3b540ba0}{goal}}.position.z);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00032}00032\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{class_controller_a7db93fa14ecab45aff1cd799ac922411}{flyToGoal}}(vehicle,\ command.\mbox{\hyperlink{struct_vehicle_data_1_1_command_a535b4b5836f0c1f681e9742c3b540ba0}{goal}});}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00033}00033\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00034}00034\ \ \ \ \ \textcolor{keywordflow}{case}\ \mbox{\hyperlink{struct_vehicle_data_1_1_command_ad4da8b67775a3eb99887a5c052775581a615a46af313786fc4e349f34118be111}{VehicleData::Command::Type::STOP}}:}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00035}00035\ \ \ \ \ \ \ \ \ RCLCPP\_INFO(logger\_,\ \textcolor{stringliteral}{"{}Processing\ STOP\ command\ for\ \%s"{}},\ vehicle.\mbox{\hyperlink{struct_vehicle_data_a5ecdf99bc0b878875df1289ad92d32f2}{id}}.c\_str());}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00036}00036\ \ \ \ \ \ \ \ \ vehicle.\mbox{\hyperlink{struct_vehicle_data_a5382e405bd93a7fd66cf458a6a13530d}{mission\_active}}\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00037}00037\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00038}00038\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00039}00039\ \ \ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00040}00040\ \ \ \ \ \ \ \ \ RCLCPP\_ERROR(logger\_,\ \textcolor{stringliteral}{"{}Unknown\ command\ type\ for\ \%s"{}},\ vehicle.\mbox{\hyperlink{struct_vehicle_data_a5ecdf99bc0b878875df1289ad92d32f2}{id}}.c\_str());}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00041}00041\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00042}00042\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00043}00043\ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00044}00044\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00045}\mbox{\hyperlink{class_controller_a80ae4d8c4f5f5d8691949ac6bc72a2bc}{00045}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{class_controller_a80ae4d8c4f5f5d8691949ac6bc72a2bc}{Controller::startMission}}(\mbox{\hyperlink{struct_vehicle_data}{VehicleData}}\ \&vehicle)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00046}00046\ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00047}00047\ \ \ \ \ \textcolor{comment}{//\ Clear\ existing\ command\ queue}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00048}00048\ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00049}00049\ \ \ \ \ \ \ \ \ std::lock\_guard<std::mutex>\ lock(vehicle.\mbox{\hyperlink{struct_vehicle_data_af6b3e23ada19b9f03778c0b7d3903cbf}{queue\_mutex}});}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00050}00050\ \ \ \ \ \ \ \ \ std::queue<VehicleData::Command>\ empty;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00051}00051\ \ \ \ \ \ \ \ \ std::swap(vehicle.\mbox{\hyperlink{struct_vehicle_data_a8be7a65752b867e1af2cfc63994e6cde}{command\_queue}},\ empty);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00052}00052\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00053}00053\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00054}00054\ \ \ \ \ \textcolor{comment}{//\ Set\ mission\ parameters}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00055}00055\ \ \ \ \ vehicle.\mbox{\hyperlink{struct_vehicle_data_a5382e405bd93a7fd66cf458a6a13530d}{mission\_active}}\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00056}00056\ \ \ \ \ vehicle.\mbox{\hyperlink{struct_vehicle_data_a290e8d8716e7a01eee91d0c2eca7e5a7}{current\_goal\_index}}\ =\ 0;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00057}00057\ \ \ \ \ vehicle.\mbox{\hyperlink{struct_vehicle_data_a93fe475471ff72b787605ee9e6cc5ed0}{mission\_progress}}\ =\ 0.0;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00058}00058\ \ \ \ \ vehicle.\mbox{\hyperlink{struct_vehicle_data_a5848e81010b8e903f25fd51cc6c5b959}{takeoff\_complete}}\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00059}00059\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00060}00060\ \ \ \ \ \textcolor{comment}{//\ Add\ takeoff\ command}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00061}00061\ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00062}00062\ \ \ \ \ \ \ \ \ std::lock\_guard<std::mutex>\ lock(vehicle.\mbox{\hyperlink{struct_vehicle_data_af6b3e23ada19b9f03778c0b7d3903cbf}{queue\_mutex}});}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00063}00063\ \ \ \ \ \ \ \ \ vehicle.\mbox{\hyperlink{struct_vehicle_data_a8be7a65752b867e1af2cfc63994e6cde}{command\_queue}}.push(\mbox{\hyperlink{struct_vehicle_data_1_1_command}{VehicleData::Command}}(\mbox{\hyperlink{struct_vehicle_data_1_1_command_ad4da8b67775a3eb99887a5c052775581a8fabc74a4ed0781d663336cbf8c9c53d}{VehicleData::Command::Type::TAKEOFF}}));}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00064}00064\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00065}00065\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00066}00066\ \ \ \ \ \textcolor{comment}{//\ Add\ goals}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00067}00067\ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00068}00068\ \ \ \ \ \ \ \ \ std::lock\_guard<std::mutex>\ lock(vehicle.\mbox{\hyperlink{struct_vehicle_data_a61a2a2efc45e41880f389165fc9b0db8}{goals\_mutex}});}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00069}00069\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keyword}{const}\ \textcolor{keyword}{auto}\ \&goal\ :\ vehicle.\mbox{\hyperlink{struct_vehicle_data_abd7e6d447227a89756f624b3c3097c42}{goals}})}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00070}00070\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00071}00071\ \ \ \ \ \ \ \ \ \ \ \ \ std::lock\_guard<std::mutex>\ lock\_queue(vehicle.\mbox{\hyperlink{struct_vehicle_data_af6b3e23ada19b9f03778c0b7d3903cbf}{queue\_mutex}});}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00072}00072\ \ \ \ \ \ \ \ \ \ \ \ \ vehicle.\mbox{\hyperlink{struct_vehicle_data_a8be7a65752b867e1af2cfc63994e6cde}{command\_queue}}.push(}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00073}00073\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{struct_vehicle_data_1_1_command}{VehicleData::Command}}(\mbox{\hyperlink{struct_vehicle_data_1_1_command_ad4da8b67775a3eb99887a5c052775581a0d19465986ce26eceefd63e055ccdeaa}{VehicleData::Command::Type::FLYING}},\ goal));}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00074}00074\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00075}00075\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00076}00076\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00077}00077\ \ \ \ \ \textcolor{comment}{//\ Let\ drone\ hover\ after\ completing\ last\ goal\ so\ it\ can\ do\ new\ goals\ if\ published}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00078}00078\ \ \ \ \ \textcolor{comment}{//\ Landing\ will\ only\ happen\ when\ mission\ is\ explicitly\ stopped\ or\ new\ goals\ require\ it}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00079}00079\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00080}00080\ \ \ \ \ \textcolor{comment}{//\ Notify\ controller\ thread}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00081}00081\ \ \ \ \ vehicle.\mbox{\hyperlink{struct_vehicle_data_af248cbb07c20205baae79114be44a7a1}{queue\_cv}}.notify\_one();}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00082}00082\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00083}00083\ \ \ \ \ RCLCPP\_INFO(logger\_,\ \textcolor{stringliteral}{"{}Mission\ started\ -\/\ drone\ will\ hover\ at\ final\ goal\ until\ new\ commands\ received"{}});}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00084}00084\ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00085}00085\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00086}\mbox{\hyperlink{class_controller_a820ca479686e960d1379f82dad460441}{00086}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{class_controller_a820ca479686e960d1379f82dad460441}{Controller::stopMission}}(\mbox{\hyperlink{struct_vehicle_data}{VehicleData}}\ \&vehicle)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00087}00087\ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00088}00088\ \ \ \ \ \textcolor{comment}{//\ Clear\ existing\ command\ queue}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00089}00089\ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00090}00090\ \ \ \ \ \ \ \ \ std::lock\_guard<std::mutex>\ lock(vehicle.\mbox{\hyperlink{struct_vehicle_data_af6b3e23ada19b9f03778c0b7d3903cbf}{queue\_mutex}});}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00091}00091\ \ \ \ \ \ \ \ \ std::queue<VehicleData::Command>\ empty;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00092}00092\ \ \ \ \ \ \ \ \ std::swap(vehicle.\mbox{\hyperlink{struct_vehicle_data_a8be7a65752b867e1af2cfc63994e6cde}{command\_queue}},\ empty);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00093}00093\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00094}00094\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Stop\ command}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00095}00095\ \ \ \ \ \ \ \ \ vehicle.\mbox{\hyperlink{struct_vehicle_data_a8be7a65752b867e1af2cfc63994e6cde}{command\_queue}}.push(\mbox{\hyperlink{struct_vehicle_data_1_1_command}{VehicleData::Command}}(\mbox{\hyperlink{struct_vehicle_data_1_1_command_ad4da8b67775a3eb99887a5c052775581a615a46af313786fc4e349f34118be111}{VehicleData::Command::Type::STOP}}));}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00096}00096\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00097}00097\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Landing\ command}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00098}00098\ \ \ \ \ \ \ \ \ vehicle.\mbox{\hyperlink{struct_vehicle_data_a8be7a65752b867e1af2cfc63994e6cde}{command\_queue}}.push(\mbox{\hyperlink{struct_vehicle_data_1_1_command}{VehicleData::Command}}(\mbox{\hyperlink{struct_vehicle_data_1_1_command_ad4da8b67775a3eb99887a5c052775581a7ab0a1cfd85cc3da16cd3e3ad7448524}{VehicleData::Command::Type::LANDING}}));}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00099}00099\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00100}00100\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00101}00101\ \ \ \ \ \textcolor{comment}{//\ Notify\ controller\ thread}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00102}00102\ \ \ \ \ vehicle.\mbox{\hyperlink{struct_vehicle_data_af248cbb07c20205baae79114be44a7a1}{queue\_cv}}.notify\_one();}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00103}00103\ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00104}00104\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00105}\mbox{\hyperlink{class_controller_a68cafe80a04b33fb2a6abd3ada2c6e47}{00105}}\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{class_controller_a68cafe80a04b33fb2a6abd3ada2c6e47}{Controller::takeoff}}(\mbox{\hyperlink{struct_vehicle_data}{VehicleData}}\ \&vehicle)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00106}00106\ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00107}00107\ \ \ \ \ RCLCPP\_INFO(logger\_,\ \textcolor{stringliteral}{"{}Taking\ off\ \%s..."{}},\ vehicle.\mbox{\hyperlink{struct_vehicle_data_a5ecdf99bc0b878875df1289ad92d32f2}{id}}.c\_str());}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00108}00108\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00109}00109\ \ \ \ \ \textcolor{comment}{//\ Publish\ takeoff\ command\ -\/\ send\ multiple\ times\ to\ ensure\ it's\ received}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00110}00110\ \ \ \ \ std\_msgs::msg::Empty\ takeoff\_msg;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00111}00111\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ 5;\ i++)\ \textcolor{comment}{//\ 5\ repetitions}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00112}00112\ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00113}00113\ \ \ \ \ \ \ \ \ takeoff\_pub\_-\/>publish(takeoff\_msg);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00114}00114\ \ \ \ \ \ \ \ \ std::this\_thread::sleep\_for(std::chrono::milliseconds(100));\ \textcolor{comment}{//\ delay\ each\ message\ send\ to\ not\ overload}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00115}00115\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00116}00116\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00117}00117\ \ \ \ \ \textcolor{comment}{//\ Initial\ climb}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00118}00118\ \ \ \ \ current\_altitude\_adjustment\_\ =\ 1.0;\ \textcolor{comment}{//\ 1m/s,\ increase\ if\ needs\ to\ be\ more\ aggressive}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00119}00119\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00120}00120\ \ \ \ \ \textcolor{comment}{//\ Log\ takeoff\ completion}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00121}00121\ \ \ \ \ RCLCPP\_INFO(logger\_,\ \textcolor{stringliteral}{"{}Takeoff\ initiated\ for\ \%s"{}},\ vehicle.\mbox{\hyperlink{struct_vehicle_data_a5ecdf99bc0b878875df1289ad92d32f2}{id}}.c\_str());}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00122}00122\ \ \ \ \ vehicle.\mbox{\hyperlink{struct_vehicle_data_a5848e81010b8e903f25fd51cc6c5b959}{takeoff\_complete}}\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00123}00123\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00124}00124\ \ \ \ \ \textcolor{comment}{//\ Send\ direct\ climb\ command}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00125}00125\ \ \ \ \ geometry\_msgs::msg::Twist\ cmd\_vel;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00126}00126\ \ \ \ \ cmd\_vel.linear.z\ =\ 1.0;\ \textcolor{comment}{//\ Force\ strong\ initial\ ascent}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00127}00127\ \ \ \ \ cmd\_vel\_pub\_-\/>publish(cmd\_vel);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00128}00128\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00129}00129\ \ \ \ \ \textcolor{comment}{//\ Wait\ for\ drone\ to\ reach\ minimum\ safe\ height}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00130}00130\ \ \ \ \ rclcpp::Rate\ rate(10);\ \textcolor{comment}{//\ 10\ Hz}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00131}00131\ \ \ \ \ \textcolor{keywordtype}{int}\ timeout\ =\ 100;\ \ \ \ \ \textcolor{comment}{//\ 10\ seconds\ timeout}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00132}00132\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00133}00133\ \ \ \ \ RCLCPP\_INFO(logger\_,\ \textcolor{stringliteral}{"{}Waiting\ for\ drone\ to\ reach\ safe\ takeoff\ height..."{}});}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00134}00134\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00135}00135\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ timeout;\ i++)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00136}00136\ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00137}00137\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ altitude\ =\ 0.0;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00138}00138\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00139}00139\ \ \ \ \ \ \ \ \ \ \ \ \ std::lock\_guard<std::mutex>\ lock(vehicle.\mbox{\hyperlink{struct_vehicle_data_a6a22a546984258477a8abd6b92806d10}{odom\_mutex}});}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00140}00140\ \ \ \ \ \ \ \ \ \ \ \ \ altitude\ =\ vehicle.\mbox{\hyperlink{struct_vehicle_data_a9e46de27b5c8605d0ae27321237b1091}{current\_odom}}.pose.pose.position.z;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00141}00141\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00142}00142\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00143}00143\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Debug\ output\ at\ 1Hz}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00144}00144\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (i\ \%\ 10\ ==\ 0)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00145}00145\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00146}00146\ \ \ \ \ \ \ \ \ \ \ \ \ RCLCPP\_INFO(logger\_,\ \textcolor{stringliteral}{"{}Takeoff\ progress:\ \%.2fm\ (target:\ 2.5m)"{}},\ altitude);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00147}00147\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00148}00148\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00149}00149\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Periodically\ resend\ climb\ command}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00150}00150\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (i\ \%\ 20\ ==\ 0)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00151}00151\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00152}00152\ \ \ \ \ \ \ \ \ \ \ \ \ cmd\_vel.linear.z\ =\ 1.0;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00153}00153\ \ \ \ \ \ \ \ \ \ \ \ \ cmd\_vel\_pub\_-\/>publish(cmd\_vel);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00154}00154\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00155}00155\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00156}00156\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (altitude\ >\ 2.5)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00157}00157\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00158}00158\ \ \ \ \ \ \ \ \ \ \ \ \ RCLCPP\_INFO(logger\_,\ \textcolor{stringliteral}{"{}Drone\ reached\ safe\ takeoff\ height:\ \%.2fm"{}},\ altitude);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00159}00159\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00160}00160\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00161}00161\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00162}00162\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (i\ ==\ timeout\ -\/\ 1)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00163}00163\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00164}00164\ \ \ \ \ \ \ \ \ \ \ \ \ RCLCPP\_WARN(logger\_,\ \textcolor{stringliteral}{"{}Takeoff\ timeout\ -\/\ drone\ reached\ \%.2fm\ (wanted\ 2.5m)"{}},\ altitude);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00165}00165\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00166}00166\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00167}00167\ \ \ \ \ \ \ \ \ rate.sleep();}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00168}00168\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00169}00169\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00170}00170\ \ \ \ \ \textcolor{comment}{//\ Stabilise\ at\ takeoff\ height}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00171}00171\ \ \ \ \ cmd\_vel.linear.z\ =\ 0.0;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00172}00172\ \ \ \ \ cmd\_vel\_pub\_-\/>publish(cmd\_vel);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00173}00173\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00174}00174\ \ \ \ \ \textcolor{comment}{//\ Reset\ altitude\ adjustment\ to\ neutral}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00175}00175\ \ \ \ \ current\_altitude\_adjustment\_\ =\ 0.0;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00176}00176\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00177}00177\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00178}00178\ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00179}00179\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00180}\mbox{\hyperlink{class_controller_ad88269eeca9c75ba490895d693a08260}{00180}}\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{class_controller_ad88269eeca9c75ba490895d693a08260}{Controller::land}}(\mbox{\hyperlink{struct_vehicle_data}{VehicleData}}\ \&vehicle)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00181}00181\ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00182}00182\ \ \ \ \ RCLCPP\_INFO(logger\_,\ \textcolor{stringliteral}{"{}Landing\ \%s..."{}},\ vehicle.\mbox{\hyperlink{struct_vehicle_data_a5ecdf99bc0b878875df1289ad92d32f2}{id}}.c\_str());}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00183}00183\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00184}00184\ \ \ \ \ \textcolor{comment}{//\ Publish\ landing\ command}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00185}00185\ \ \ \ \ std\_msgs::msg::Empty\ land\_msg;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00186}00186\ \ \ \ \ land\_pub\_-\/>publish(land\_msg);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00187}00187\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00188}00188\ \ \ \ \ vehicle.\mbox{\hyperlink{struct_vehicle_data_a5848e81010b8e903f25fd51cc6c5b959}{takeoff\_complete}}\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00189}00189\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00190}00190\ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00191}00191\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00192}\mbox{\hyperlink{class_controller_a7db93fa14ecab45aff1cd799ac922411}{00192}}\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{class_controller_a7db93fa14ecab45aff1cd799ac922411}{Controller::flyToGoal}}(\mbox{\hyperlink{struct_vehicle_data}{VehicleData}}\&\ vehicle,\ \textcolor{keyword}{const}\ geometry\_msgs::msg::Pose\&\ goal)\ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00193}00193\ \ \ \ \ \textcolor{comment}{//\ Check\ if\ this\ specific\ goal\ has\ altitude\ override\ (z\ >\ 0.1),\ This\ makes\ it\ trigger\ for\ z\ >\ 2,\ idk\ why}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00194}00194\ \ \ \ \ \textcolor{keywordtype}{bool}\ use\_manual\_altitude\ =\ (goal.position.z\ >\ 0.1);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00195}00195\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00196}00196\ \ \ \ \ \textcolor{keywordflow}{if}\ (use\_manual\_altitude)\ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00197}00197\ \ \ \ \ \ \ \ \ RCLCPP\_INFO(logger\_,\ \textcolor{stringliteral}{"{}Flying\ \%s\ to\ goal:\ [\%.2f,\ \%.2f,\ \%.2f]\ (MANUAL\ ALTITUDE)"{}},}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00198}00198\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ vehicle.\mbox{\hyperlink{struct_vehicle_data_a5ecdf99bc0b878875df1289ad92d32f2}{id}}.c\_str(),\ goal.position.x,\ goal.position.y,\ goal.position.z);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00199}00199\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00200}00200\ \ \ \ \ \ \ \ \ RCLCPP\_INFO(logger\_,\ \textcolor{stringliteral}{"{}Flying\ \%s\ to\ goal:\ [\%.2f,\ \%.2f,\ Z=terrain]\ (TERRAIN\ FOLLOWING)"{}},}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00201}00201\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ vehicle.\mbox{\hyperlink{struct_vehicle_data_a5ecdf99bc0b878875df1289ad92d32f2}{id}}.c\_str(),\ goal.position.x,\ goal.position.y);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00202}00202\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00203}00203\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00204}00204\ \ \ \ \ rclcpp::Rate\ rate(10);\ \ \textcolor{comment}{//\ 10\ Hz}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00205}00205\ \ \ \ \ \textcolor{keywordtype}{int}\ max\_attempts\ =\ 1800;\ \textcolor{comment}{//\ Maximum\ 3\ minutes}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00206}00206\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00207}00207\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ max\_attempts;\ i++)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00208}00208\ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00209}00209\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!vehicle.\mbox{\hyperlink{struct_vehicle_data_a5382e405bd93a7fd66cf458a6a13530d}{mission\_active}})\ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00210}00210\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00211}00211\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00212}00212\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00213}00213\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Get\ current\ position}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00214}00214\ \ \ \ \ \ \ \ \ geometry\_msgs::msg::Point\ current\_pos;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00215}00215\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00216}00216\ \ \ \ \ \ \ \ \ \ \ \ \ std::lock\_guard<std::mutex>\ lock(vehicle.\mbox{\hyperlink{struct_vehicle_data_a6a22a546984258477a8abd6b92806d10}{odom\_mutex}});}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00217}00217\ \ \ \ \ \ \ \ \ \ \ \ \ current\_pos\ =\ vehicle.\mbox{\hyperlink{struct_vehicle_data_a9e46de27b5c8605d0ae27321237b1091}{current\_odom}}.pose.pose.position;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00218}00218\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00219}00219\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00220}00220\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Calculate\ horizontal\ distance\ to\ goal}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00221}00221\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ dx\ =\ goal.position.x\ -\/\ current\_pos.x;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00222}00222\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ dy\ =\ goal.position.y\ -\/\ current\_pos.y;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00223}00223\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ horizontal\_distance\ =\ std::sqrt(dx*dx\ +\ dy*dy);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00224}00224\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00225}00225\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Check\ if\ goal\ reached}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00226}00226\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ goal\_reached\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00227}00227\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (use\_manual\_altitude)\ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00228}00228\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ altitude\_distance\ =\ std::abs(goal.position.z\ -\/\ current\_pos.z);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00229}00229\ \ \ \ \ \ \ \ \ \ \ \ \ goal\_reached\ =\ (horizontal\_distance\ <\ 0.5\ \&\&\ altitude\_distance\ <\ 0.3);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00230}00230\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00231}00231\ \ \ \ \ \ \ \ \ \ \ \ \ goal\_reached\ =\ (horizontal\_distance\ <\ 0.5);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00232}00232\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00233}00233\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00234}00234\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (goal\_reached)\ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00235}00235\ \ \ \ \ \ \ \ \ \ \ \ \ RCLCPP\_INFO(logger\_,\ \textcolor{stringliteral}{"{}Goal\ reached\ for\ \%s"{}},\ vehicle.\mbox{\hyperlink{struct_vehicle_data_a5ecdf99bc0b878875df1289ad92d32f2}{id}}.c\_str());}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00236}00236\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00237}00237\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Brief\ hover\ then\ return}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00238}00238\ \ \ \ \ \ \ \ \ \ \ \ \ geometry\_msgs::msg::Twist\ hover\_cmd;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00239}00239\ \ \ \ \ \ \ \ \ \ \ \ \ hover\_cmd.linear.x\ =\ 0.0;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00240}00240\ \ \ \ \ \ \ \ \ \ \ \ \ hover\_cmd.linear.y\ =\ 0.0;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00241}00241\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00242}00242\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (use\_manual\_altitude)\ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00243}00243\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ altitude\_error\ =\ goal.position.z\ -\/\ current\_pos.z;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00244}00244\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ hover\_cmd.linear.z\ =\ altitude\_error\ *\ 0.3;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00245}00245\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ hover\_cmd.linear.z\ =\ std::clamp(hover\_cmd.linear.z,\ -\/0.2,\ 0.2);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00246}00246\ \ \ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00247}00247\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Current\ altitude\ adjustment\ from\ controller\ thread}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00248}00248\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ hover\_cmd.linear.z\ =\ current\_altitude\_adjustment\_;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00249}00249\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00250}00250\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00251}00251\ \ \ \ \ \ \ \ \ \ \ \ \ cmd\_vel\_pub\_-\/>publish(hover\_cmd);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00252}00252\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00253}00253\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Short\ hover\ period\ then\ continue}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00254}00254\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ hover\_count\ =\ 0;\ hover\_count\ <\ 10;\ hover\_count++)\ \{\ \ \textcolor{comment}{//\ 1\ second\ hover}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00255}00255\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ cmd\_vel\_pub\_-\/>publish(hover\_cmd);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00256}00256\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ rate.sleep();}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00257}00257\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00258}00258\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00259}00259\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00260}00260\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00261}00261\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00262}00262\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Gradual\ approach\ to\ avoid\ spiraling}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00263}00263\ \ \ \ \ \ \ \ \ geometry\_msgs::msg::Twist\ cmd\_vel;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00264}00264\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00265}00265\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Horizontal\ movement\ with\ speed\ ramping}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00266}00266\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (horizontal\_distance\ >\ 0.1)\ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00267}00267\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ base\_speed\ =\ 0.8;\ \ \textcolor{comment}{//\ Base\ speed\ in\ m/s}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00268}00268\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00269}00269\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Adaptive\ speed\ based\ on\ distance\ to\ avoid\ spiraling\ }}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00270}00270\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ speed\_factor;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00271}00271\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (horizontal\_distance\ >\ 2.0)\ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00272}00272\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ speed\_factor\ =\ 1.0;\ \ \ \ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00273}00273\ \ \ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00274}00274\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Slow\ when\ approaching\ target}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00275}00275\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ speed\_factor\ =\ std::max(0.3,\ horizontal\_distance\ /\ 2.0);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00276}00276\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00277}00277\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00278}00278\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Direct\ velocity}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00279}00279\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ target\_speed\ =\ base\_speed\ *\ speed\_factor;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00280}00280\ \ \ \ \ \ \ \ \ \ \ \ \ cmd\_vel.linear.x\ =\ (dx\ /\ horizontal\_distance)\ *\ target\_speed;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00281}00281\ \ \ \ \ \ \ \ \ \ \ \ \ cmd\_vel.linear.y\ =\ (dy\ /\ horizontal\_distance)\ *\ target\_speed;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00282}00282\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00283}00283\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00284}00284\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Close\ to\ target\ -\/\ stop\ horizontal\ movement}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00285}00285\ \ \ \ \ \ \ \ \ \ \ \ \ cmd\_vel.linear.x\ =\ 0.0;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00286}00286\ \ \ \ \ \ \ \ \ \ \ \ \ cmd\_vel.linear.y\ =\ 0.0;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00287}00287\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00288}00288\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00289}00289\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Altitude\ control\ }}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00290}00290\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (use\_manual\_altitude)\ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00291}00291\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ altitude\_error\ =\ goal.position.z\ -\/\ current\_pos.z;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00292}00292\ \ \ \ \ \ \ \ \ \ \ \ \ cmd\_vel.linear.z\ =\ altitude\_error\ *\ 0.4;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00293}00293\ \ \ \ \ \ \ \ \ \ \ \ \ cmd\_vel.linear.z\ =\ std::clamp(cmd\_vel.linear.z,\ -\/0.4,\ 0.4);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00294}00294\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00295}00295\ \ \ \ \ \ \ \ \ \ \ \ \ cmd\_vel.linear.z\ =\ current\_altitude\_adjustment\_;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00296}00296\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00297}00297\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (current\_pos.z\ >\ 8.0\ \&\&\ cmd\_vel.linear.z\ >\ 0)\ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00298}00298\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ cmd\_vel.linear.z\ =\ std::min(cmd\_vel.linear.z,\ 0.0);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00299}00299\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00300}00300\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00301}00301\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00302}00302\ \ \ \ \ \ \ \ \ cmd\_vel\_pub\_-\/>publish(cmd\_vel);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00303}00303\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00304}00304\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Less\ frequent\ debug\ output\ to\ reduce\ log\ spam}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00305}00305\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (i\ \%\ 20\ ==\ 0)\ \{\ \ \textcolor{comment}{//\ Every\ 2\ seconds}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00306}00306\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (use\_manual\_altitude)\ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00307}00307\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ RCLCPP\_INFO(logger\_,\ \textcolor{stringliteral}{"{}Distance:\ \%.2fm,\ altitude:\ \%.2fm-\/>\%.2fm\ (MANUAL)"{}},\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00308}00308\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ horizontal\_distance,\ current\_pos.z,\ goal.position.z);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00309}00309\ \ \ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00310}00310\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ RCLCPP\_INFO(logger\_,\ \textcolor{stringliteral}{"{}Distance:\ \%.2fm,\ altitude:\ \%.2fm\ (TERRAIN)"{}},\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00311}00311\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ horizontal\_distance,\ current\_pos.z);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00312}00312\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00313}00313\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00314}00314\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00315}00315\ \ \ \ \ \ \ \ \ rate.sleep();}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00316}00316\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00317}00317\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00318}00318\ \ \ \ \ RCLCPP\_ERROR(logger\_,\ \textcolor{stringliteral}{"{}Failed\ to\ reach\ goal\ within\ time\ limit"{}});}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00319}00319\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00320}00320\ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00321}00321\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00322}\mbox{\hyperlink{class_controller_ac12e40ab614fa55783149718a22ce68e}{00322}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{class_controller_ac12e40ab614fa55783149718a22ce68e}{Controller::abortMission}}(\mbox{\hyperlink{struct_vehicle_data}{VehicleData}}\ \&vehicle)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00323}00323\ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00324}00324\ \ \ \ \ RCLCPP\_WARN(logger\_,\ \textcolor{stringliteral}{"{}Aborting\ mission\ for\ \%s\ -\/\ returning\ to\ start\ position"{}},}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00325}00325\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ vehicle.\mbox{\hyperlink{struct_vehicle_data_a5ecdf99bc0b878875df1289ad92d32f2}{id}}.c\_str());}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00326}00326\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00327}00327\ \ \ \ \ \textcolor{comment}{//\ Clear\ existing\ command\ queue}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00328}00328\ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00329}00329\ \ \ \ \ \ \ \ \ std::lock\_guard<std::mutex>\ lock(vehicle.\mbox{\hyperlink{struct_vehicle_data_af6b3e23ada19b9f03778c0b7d3903cbf}{queue\_mutex}});}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00330}00330\ \ \ \ \ \ \ \ \ std::queue<VehicleData::Command>\ empty;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00331}00331\ \ \ \ \ \ \ \ \ std::swap(vehicle.\mbox{\hyperlink{struct_vehicle_data_a8be7a65752b867e1af2cfc63994e6cde}{command\_queue}},\ empty);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00332}00332\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00333}00333\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Get\ current\ position\ for\ safety\ check}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00334}00334\ \ \ \ \ \ \ \ \ geometry\_msgs::msg::Point\ current\_pos;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00335}00335\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00336}00336\ \ \ \ \ \ \ \ \ \ \ \ \ std::lock\_guard<std::mutex>\ odom\_lock(vehicle.\mbox{\hyperlink{struct_vehicle_data_a6a22a546984258477a8abd6b92806d10}{odom\_mutex}});}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00337}00337\ \ \ \ \ \ \ \ \ \ \ \ \ current\_pos\ =\ vehicle.\mbox{\hyperlink{struct_vehicle_data_a9e46de27b5c8605d0ae27321237b1091}{current\_odom}}.pose.pose.position;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00338}00338\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00339}00339\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00340}00340\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Only\ return\ to\ start\ if\ we're\ far\ from\ it\ (Change\ later\ so\ it\ returns\ to\ 0,\ 0\ regardless\ and\ lands)\ -\/\ INCOMPLETE}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00341}00341\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ dist\_to\_start\ =\ \mbox{\hyperlink{class_controller_a98a5028b8184631ddd6aab9b2dea12ca}{calculateDistance}}(current\_pos,\ vehicle.\mbox{\hyperlink{struct_vehicle_data_ae28b0d91773c74cea4eda56c32a67470}{start\_position}}.position);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00342}00342\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (dist\_to\_start\ >\ 1.0)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00343}00343\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00344}00344\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Add\ command\ to\ return\ to\ starting\ position}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00345}00345\ \ \ \ \ \ \ \ \ \ \ \ \ vehicle.\mbox{\hyperlink{struct_vehicle_data_a8be7a65752b867e1af2cfc63994e6cde}{command\_queue}}.push(}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00346}00346\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{struct_vehicle_data_1_1_command}{VehicleData::Command}}(\mbox{\hyperlink{struct_vehicle_data_1_1_command_ad4da8b67775a3eb99887a5c052775581a0d19465986ce26eceefd63e055ccdeaa}{VehicleData::Command::Type::FLYING}},}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00347}00347\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ vehicle.\mbox{\hyperlink{struct_vehicle_data_ae28b0d91773c74cea4eda56c32a67470}{start\_position}}));}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00348}00348\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00349}00349\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00350}00350\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Landing\ command}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00351}00351\ \ \ \ \ \ \ \ \ vehicle.\mbox{\hyperlink{struct_vehicle_data_a8be7a65752b867e1af2cfc63994e6cde}{command\_queue}}.push(}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00352}00352\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{struct_vehicle_data_1_1_command}{VehicleData::Command}}(\mbox{\hyperlink{struct_vehicle_data_1_1_command_ad4da8b67775a3eb99887a5c052775581a7ab0a1cfd85cc3da16cd3e3ad7448524}{VehicleData::Command::Type::LANDING}}));}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00353}00353\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00354}00354\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Mark\ mission\ as\ failed}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00355}00355\ \ \ \ \ \ \ \ \ vehicle.\mbox{\hyperlink{struct_vehicle_data_a5382e405bd93a7fd66cf458a6a13530d}{mission\_active}}\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00356}00356\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00357}00357\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00358}00358\ \ \ \ \ \textcolor{comment}{//\ Notify\ controller\ thread}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00359}00359\ \ \ \ \ vehicle.\mbox{\hyperlink{struct_vehicle_data_af248cbb07c20205baae79114be44a7a1}{queue\_cv}}.notify\_one();}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00360}00360\ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00361}00361\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00362}00362\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00363}00363\ \textcolor{comment}{//\ This\ function\ only\ works\ when\ the\ drone\ hasn't\ taken\ off???}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00364}\mbox{\hyperlink{class_controller_aa02ddd33030d8be14cb453655c08cba0}{00364}}\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{class_controller_aa02ddd33030d8be14cb453655c08cba0}{Controller::checkForObstacles}}(\textcolor{keyword}{const}\ sensor\_msgs::msg::LaserScan::SharedPtr\ \&laser\_scan)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00365}00365\ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00366}00366\ \ \ \ \ \textcolor{keywordflow}{if}\ (!laser\_scan)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00367}00367\ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00368}00368\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00369}00369\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00370}00370\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00371}00371\ \ \ \ \ \textcolor{comment}{//\ Check\ ALL\ 360\ degrees\ for\ obstacles}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00372}00372\ \ \ \ \ \textcolor{keywordtype}{double}\ critical\_distance\ =\ 1.0;\ \textcolor{comment}{//\ 1m,\ emergency\ ascent}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00373}00373\ \ \ \ \ \textcolor{keywordtype}{double}\ warning\_distance\ =\ 3.0;\ \ \textcolor{comment}{//\ 3m\ warning\ distance}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00374}00374\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00375}00375\ \ \ \ \ \textcolor{keywordtype}{bool}\ obstacle\_detected\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00376}00376\ \ \ \ \ \textcolor{keywordtype}{double}\ closest\_range\ =\ std::numeric\_limits<double>::max();}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00377}00377\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00378}00378\ \ \ \ \ \textcolor{comment}{//\ Check\ all\ laser\ readings}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00379}00379\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ laser\_scan-\/>ranges.size();\ i++)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00380}00380\ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00381}00381\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{float}\ range\ =\ laser\_scan-\/>ranges[i];}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00382}00382\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00383}00383\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Check\ if\ reading\ is\ valid}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00384}00384\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!std::isnan(range)\ \&\&\ !std::isinf(range)\ \&\&}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00385}00385\ \ \ \ \ \ \ \ \ \ \ \ \ range\ >\ laser\_scan-\/>range\_min\ \&\&}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00386}00386\ \ \ \ \ \ \ \ \ \ \ \ \ range\ <\ laser\_scan-\/>range\_max)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00387}00387\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00388}00388\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00389}00389\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (range\ <\ closest\_range)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00390}00390\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00391}00391\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ closest\_range\ =\ range;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00392}00392\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00393}00393\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00394}00394\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (range\ <\ critical\_distance)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00395}00395\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00396}00396\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ obstacle\_detected\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00397}00397\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00398}00398\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Calculate\ angle\ of\ obstacle}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00399}00399\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{float}\ angle\ =\ laser\_scan-\/>angle\_min\ +\ (i\ *\ laser\_scan-\/>angle\_increment);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00400}00400\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{float}\ angle\_deg\ =\ angle\ *\ 180.0\ /\ M\_PI;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00401}00401\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00402}00402\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ RCLCPP\_ERROR(logger\_,\ \textcolor{stringliteral}{"{}OBSTACLE\ at\ \%.2fm,\ angle\ \%.1f\ degrees\ -\/\ EMERGENCY\ ASCENT!"{}},}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00403}00403\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ range,\ angle\_deg);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00404}00404\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00405}00405\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (range\ <\ warning\_distance)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00406}00406\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00407}00407\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Simple\ throttling\ using\ static\ variable}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00408}00408\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{auto}\ last\_warning\ =\ std::chrono::steady\_clock::now();}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00409}00409\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ now\ =\ std::chrono::steady\_clock::now();}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00410}00410\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00411}00411\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (std::chrono::duration\_cast<std::chrono::milliseconds>(now\ -\/\ last\_warning).count()\ >\ 1000)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00412}00412\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00413}00413\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{float}\ angle\ =\ laser\_scan-\/>angle\_min\ +\ (i\ *\ laser\_scan-\/>angle\_increment);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00414}00414\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{float}\ angle\_deg\ =\ angle\ *\ 180.0\ /\ M\_PI;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00415}00415\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00416}00416\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ RCLCPP\_WARN(logger\_,\ \textcolor{stringliteral}{"{}Obstacle\ at\ \%.2fm,\ angle\ \%.1f\ degrees"{}},}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00417}00417\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ range,\ angle\_deg);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00418}00418\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ last\_warning\ =\ now;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00419}00419\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00420}00420\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00421}00421\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00422}00422\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00423}00423\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00424}00424\ \ \ \ \ \textcolor{keywordflow}{if}\ (obstacle\_detected)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00425}00425\ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00426}00426\ \ \ \ \ \ \ \ \ RCLCPP\_ERROR(logger\_,\ \textcolor{stringliteral}{"{}Closest\ obstacle\ at\ \%.2fm\ -\/\ must\ ascend\ immediately!"{}},\ closest\_range);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00427}00427\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00428}00428\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00429}00429\ \ \ \ \ \textcolor{keywordflow}{return}\ obstacle\_detected;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00430}00430\ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00431}00431\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00432}\mbox{\hyperlink{class_controller_a4ab193fb724ed8e6228b8628cc377ba7}{00432}}\ \textcolor{keywordtype}{double}\ \mbox{\hyperlink{class_controller_a4ab193fb724ed8e6228b8628cc377ba7}{Controller::calculateAltitudeAdjustment}}(\textcolor{keywordtype}{double}\ current\_altitude,\ \textcolor{keywordtype}{double}\ sonar\_range)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00433}00433\ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00434}00434\ \ \ \ \ \textcolor{comment}{//\ Print\ raw\ data\ for\ debugging}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00435}00435\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{int}\ debug\_counter\ =\ 0;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00436}00436\ \ \ \ \ \textcolor{keywordflow}{if}\ (++debug\_counter\ \%\ 10\ ==\ 0)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00437}00437\ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00438}00438\ \ \ \ \ \ \ \ \ RCLCPP\_DEBUG(logger\_,\ \textcolor{stringliteral}{"{}RAW\ sonar=\%.2fm,\ altitude=\%.2fm"{}},\ sonar\_range,\ current\_altitude);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00439}00439\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00440}00440\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00441}00441\ \ \ \ \ \textcolor{comment}{//\ Strict\ validation\ -\/\ if\ sonar\ is\ reporting\ weird\ values,\ don't\ trust\ it}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00442}00442\ \ \ \ \ \textcolor{keywordflow}{if}\ (std::isnan(sonar\_range)\ ||\ std::isinf(sonar\_range)\ ||}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00443}00443\ \ \ \ \ \ \ \ \ sonar\_range\ <=\ 0.1\ ||\ sonar\_range\ >\ 10.0)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00444}00444\ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00445}00445\ \ \ \ \ \ \ \ \ RCLCPP\_WARN(logger\_,\ \textcolor{stringliteral}{"{}Invalid\ sonar\ reading:\ \%.2f\ -\/\ stopping\ adjustment"{}},\ sonar\_range);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00446}00446\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ 0.0;\ \textcolor{comment}{//\ Return\ 0.0\ to\ prevent\ drift}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00447}00447\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00448}00448\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00449}00449\ \ \ \ \ \textcolor{comment}{//\ Target\ height\ remains\ 2.0m}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00450}00450\ \ \ \ \ \textcolor{keywordtype}{double}\ target\_height\ =\ 2.0;\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00451}00451\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00452}00452\ \ \ \ \ \textcolor{comment}{//\ Calculate\ error\ -\/\ positive\ to\ go\ up}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00453}00453\ \ \ \ \ \textcolor{keywordtype}{double}\ error\ =\ target\_height\ -\/\ sonar\_range;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00454}00454\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00455}00455\ \ \ \ \ \textcolor{comment}{//\ Add\ integral\ term\ to\ eliminate\ steady-\/state\ error}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00456}00456\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{double}\ integral\_error\ =\ 0.0;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00457}00457\ \ \ \ \ \textcolor{keywordtype}{double}\ dt\ =\ 0.1;\ \textcolor{comment}{//\ For\ 10Hz}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00458}00458\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00459}00459\ \ \ \ \ \textcolor{comment}{//\ Only\ integrate\ when\ error\ is\ small\ to\ prevent\ windup}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00460}00460\ \ \ \ \ \textcolor{keywordflow}{if}\ (std::abs(error)\ <\ 0.5)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00461}00461\ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00462}00462\ \ \ \ \ \ \ \ \ integral\_error\ +=\ error\ *\ dt;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00463}00463\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Clamp\ integral\ term\ to\ prevent\ excessive\ accumulation}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00464}00464\ \ \ \ \ \ \ \ \ integral\_error\ =\ std::clamp(integral\_error,\ -\/1.0,\ 1.0);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00465}00465\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00466}00466\ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00467}00467\ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00468}00468\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Reset\ integral\ when\ error\ is\ large}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00469}00469\ \ \ \ \ \ \ \ \ integral\_error\ =\ 0.0;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00470}00470\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00471}00471\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00472}00472\ \ \ \ \ \textcolor{comment}{//\ Asymmetric\ PI\ control\ -\/\ different\ gains\ for\ ascent\ and\ descent}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00473}00473\ \ \ \ \ \textcolor{keywordtype}{double}\ kp,\ ki;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00474}00474\ \ \ \ \ \textcolor{keywordflow}{if}\ (error\ >\ 0)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00475}00475\ \ \ \ \ \{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Too\ low\ -\/\ need\ to\ ascend}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00476}00476\ \ \ \ \ \ \ \ \ kp\ =\ 0.85;\ \textcolor{comment}{//\ Slightly\ reduced\ from\ 0.90\ to\ prevent\ overshoot}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00477}00477\ \ \ \ \ \ \ \ \ ki\ =\ 0.15;\ \textcolor{comment}{//\ Add\ integral\ term\ for\ uphill}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00478}00478\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00479}00479\ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00480}00480\ \ \ \ \ \{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Too\ high\ -\/\ need\ to\ descend}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00481}00481\ \ \ \ \ \ \ \ \ kp\ =\ 0.45;\ \textcolor{comment}{//\ Slightly\ reduced\ from\ 0.50}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00482}00482\ \ \ \ \ \ \ \ \ ki\ =\ 0.10;\ \textcolor{comment}{//\ Less\ integral\ for\ downhill\ (gravity)}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00483}00483\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00484}00484\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00485}00485\ \ \ \ \ \textcolor{comment}{//\ Calculate\ adjustment\ with\ both\ P\ and\ I\ terms}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00486}00486\ \ \ \ \ \textcolor{keywordtype}{double}\ p\_term\ =\ kp\ *\ error;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00487}00487\ \ \ \ \ \textcolor{keywordtype}{double}\ i\_term\ =\ ki\ *\ integral\_error;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00488}00488\ \ \ \ \ \textcolor{keywordtype}{double}\ adjustment\ =\ p\_term\ +\ i\_term;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00489}00489\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00490}00490\ \ \ \ \ \textcolor{comment}{//\ Allow\ faster\ ascent\ when\ too\ low\ (safety\ priority)}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00491}00491\ \ \ \ \ \textcolor{keywordtype}{double}\ max\_ascent\ =\ (error\ >\ 1.0)\ ?\ 1.0\ :\ 0.6;\ \textcolor{comment}{//\ Faster\ ascent\ when\ far\ below\ target}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00492}00492\ \ \ \ \ \textcolor{keywordtype}{double}\ max\_descent\ =\ 0.5;\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Keep\ moderate\ descent\ rate}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00493}00493\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00494}00494\ \ \ \ \ adjustment\ =\ std::clamp(adjustment,\ -\/max\_descent,\ max\_ascent);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00495}00495\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00496}00496\ \ \ \ \ \textcolor{comment}{//\ HARD\ LIMIT\ on\ absolute\ altitude\ regardless\ of\ terrain}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00497}00497\ \ \ \ \ \textcolor{keywordflow}{if}\ (current\_altitude\ >\ 8.0)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00498}00498\ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00499}00499\ \ \ \ \ \ \ \ \ RCLCPP\_ERROR(logger\_,\ \textcolor{stringliteral}{"{}MAXIMUM\ ALTITUDE\ REACHED\ (\%.2fm)\ -\/\ EMERGENCY\ DESCENT"{}},\ current\_altitude);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00500}00500\ \ \ \ \ \ \ \ \ integral\_error\ =\ 0.0;\ \textcolor{comment}{//\ Reset\ integral\ term}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00501}00501\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ -\/0.5;\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Force\ immediate\ descent}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00502}00502\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00503}00503\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00504}00504\ \ \ \ \ \textcolor{comment}{//\ Continuous\ ascent\ detection\ (safety\ feature)}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00505}00505\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{int}\ continuous\_ascent\_counter\ =\ 0;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00506}00506\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{double}\ last\_altitude\ =\ 0.0;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00507}00507\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00508}00508\ \ \ \ \ \textcolor{keywordflow}{if}\ (current\_altitude\ >\ last\_altitude\ +\ 0.05\ \&\&\ adjustment\ >\ 0.0)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00509}00509\ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00510}00510\ \ \ \ \ \ \ \ \ continuous\_ascent\_counter++;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00511}00511\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (continuous\_ascent\_counter\ >\ 20)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00512}00512\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00513}00513\ \ \ \ \ \ \ \ \ \ \ \ \ RCLCPP\_ERROR(logger\_,\ \textcolor{stringliteral}{"{}CONTINUOUS\ ASCENT\ DETECTED\ (\%.2fm)\ -\/\ EMERGENCY\ CORRECTION"{}},}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00514}00514\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ current\_altitude);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00515}00515\ \ \ \ \ \ \ \ \ \ \ \ \ continuous\_ascent\_counter\ =\ 0;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00516}00516\ \ \ \ \ \ \ \ \ \ \ \ \ integral\_error\ =\ 0.0;\ \textcolor{comment}{//\ Reset\ integral\ term}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00517}00517\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ -\/0.5;\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Force\ descent}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00518}00518\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00519}00519\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00520}00520\ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00521}00521\ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00522}00522\ \ \ \ \ \ \ \ \ continuous\_ascent\_counter\ =\ 0;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00523}00523\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00524}00524\ \ \ \ \ last\_altitude\ =\ current\_altitude;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00525}00525\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00526}00526\ \ \ \ \ \textcolor{comment}{//\ Add\ slight\ damping\ -\/\ prevent\ oscillation}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00527}00527\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{double}\ last\_adjustment\ =\ 0.0;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00528}00528\ \ \ \ \ \textcolor{keywordtype}{double}\ damped\_adjustment\ =\ 0.7\ *\ adjustment\ +\ 0.3\ *\ last\_adjustment;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00529}00529\ \ \ \ \ last\_adjustment\ =\ damped\_adjustment;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00530}00530\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00531}00531\ \ \ \ \ \textcolor{comment}{//\ More\ frequent\ debug\ logging\ with\ integral\ term\ info}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00532}00532\ \ \ \ \ \textcolor{keywordflow}{if}\ (debug\_counter\ \%\ 5\ ==\ 0)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00533}00533\ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00534}00534\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ ground\_elevation\ =\ current\_altitude\ -\/\ sonar\_range;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00535}00535\ \ \ \ \ \ \ \ \ RCLCPP\_INFO(logger\_,}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00536}00536\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}Altitude\ control:\ alt=\%.2fm,\ sonar=\%.2fm,\ target=\%.2fm,\ error=\%.2fm,\ P=\%.2f,\ I=\%.2f,\ cmd=\%.2fm/s,\ ground=\%.2fm"{}},}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00537}00537\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ current\_altitude,\ sonar\_range,\ target\_height,\ error,}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00538}00538\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ p\_term,\ i\_term,\ damped\_adjustment,\ ground\_elevation);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00539}00539\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00540}00540\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00541}00541\ \ \ \ \ \textcolor{keywordflow}{return}\ damped\_adjustment;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00542}00542\ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00543}00543\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00544}\mbox{\hyperlink{class_controller_a98a5028b8184631ddd6aab9b2dea12ca}{00544}}\ \textcolor{keywordtype}{double}\ \mbox{\hyperlink{class_controller_a98a5028b8184631ddd6aab9b2dea12ca}{Controller::calculateDistance}}(\textcolor{keyword}{const}\ geometry\_msgs::msg::Point\ \&p1,\ \textcolor{keyword}{const}\ geometry\_msgs::msg::Point\ \&p2)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00545}00545\ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00546}00546\ \ \ \ \ \textcolor{keywordtype}{double}\ dx\ =\ p2.x\ -\/\ p1.x;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00547}00547\ \ \ \ \ \textcolor{keywordtype}{double}\ dy\ =\ p2.y\ -\/\ p1.y;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00548}00548\ \ \ \ \ \textcolor{keywordtype}{double}\ dz\ =\ p2.z\ -\/\ p1.z;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00549}00549\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00550}00550\ \ \ \ \ \textcolor{keywordflow}{return}\ std::sqrt(dx\ *\ dx\ +\ dy\ *\ dy\ +\ dz\ *\ dz);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00551}00551\ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00552}00552\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00553}00553\ \textcolor{comment}{//\ Functional\ when\ drone\ doesn't\ take\ off,\ tested\ in\ Gazebo,\ breaks\ when\ drone\ is\ moving\ }}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00554}\mbox{\hyperlink{class_controller_a7e099c78a6a80248e4b7b61635c8d037}{00554}}\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{class_controller_a7e099c78a6a80248e4b7b61635c8d037}{Controller::checkObstaclesInDirection}}(\textcolor{keyword}{const}\ sensor\_msgs::msg::LaserScan::SharedPtr\ \&laser\_scan,}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00555}00555\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ geometry\_msgs::msg::Point\ \&current\_pos,}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00556}00556\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ geometry\_msgs::msg::Point\ \&target\_pos)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00557}00557\ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00558}00558\ \ \ \ \ \textcolor{keywordflow}{if}\ (!laser\_scan)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00559}00559\ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00560}00560\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00561}00561\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00562}00562\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00563}00563\ \ \ \ \ \textcolor{comment}{//\ Calculate\ direction\ of\ travel\ (NOT\ drone\ heading)}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00564}00564\ \ \ \ \ \textcolor{keywordtype}{double}\ dx\ =\ target\_pos.x\ -\/\ current\_pos.x;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00565}00565\ \ \ \ \ \textcolor{keywordtype}{double}\ dy\ =\ target\_pos.y\ -\/\ current\_pos.y;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00566}00566\ \ \ \ \ \textcolor{keywordtype}{double}\ travel\_distance\ =\ std::sqrt(dx\ *\ dx\ +\ dy\ *\ dy);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00567}00567\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00568}00568\ \ \ \ \ \textcolor{keywordflow}{if}\ (travel\_distance\ <\ 0.1)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00569}00569\ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00570}00570\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};\ \textcolor{comment}{//\ Already\ at\ target}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00571}00571\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00572}00572\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00573}00573\ \ \ \ \ \textcolor{comment}{//\ Normalise\ direction\ vector}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00574}00574\ \ \ \ \ dx\ /=\ travel\_distance;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00575}00575\ \ \ \ \ dy\ /=\ travel\_distance;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00576}00576\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00577}00577\ \ \ \ \ \textcolor{comment}{//\ Calculate\ travel\ direction\ angle\ based\ on\ navigation}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00578}00578\ \ \ \ \ \textcolor{keywordtype}{double}\ travel\_angle\ =\ std::atan2(dy,\ dx);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00579}00579\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00580}00580\ \ \ \ \ \textcolor{comment}{//\ Wide\ cone\ to\ catch\ obstacles\ in\ travel\ path}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00581}00581\ \ \ \ \ \textcolor{keywordtype}{double}\ cone\_half\_angle\ =\ M\_PI\ /\ 4.0;\ \textcolor{comment}{//\ 45\ degrees}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00582}00582\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00583}00583\ \ \ \ \ \textcolor{keywordtype}{bool}\ obstacle\_detected\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00584}00584\ \ \ \ \ \textcolor{keywordtype}{double}\ closest\_obstacle\ =\ std::numeric\_limits<double>::max();}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00585}00585\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00586}00586\ \ \ \ \ \textcolor{comment}{//\ Check\ for\ obstacles}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00587}00587\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ laser\_scan-\/>ranges.size();\ i++)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00588}00588\ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00589}00589\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{float}\ range\ =\ laser\_scan-\/>ranges[i];}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00590}00590\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00591}00591\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Skip\ invalid\ readings}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00592}00592\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (std::isnan(range)\ ||\ std::isinf(range)\ ||}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00593}00593\ \ \ \ \ \ \ \ \ \ \ \ \ range\ <=\ laser\_scan-\/>range\_min\ ||}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00594}00594\ \ \ \ \ \ \ \ \ \ \ \ \ range\ >=\ laser\_scan-\/>range\_max)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00595}00595\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00596}00596\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00597}00597\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00598}00598\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00599}00599\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Calculate\ angle}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00600}00600\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{float}\ laser\_angle\ =\ laser\_scan-\/>angle\_min\ +\ (i\ *\ laser\_scan-\/>angle\_increment);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00601}00601\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00602}00602\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Calculate\ angle\ difference\ from\ travel\ direction}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00603}00603\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ angle\_diff\ =\ std::abs(laser\_angle\ -\/\ travel\_angle);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00604}00604\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (angle\_diff\ >\ M\_PI)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00605}00605\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00606}00606\ \ \ \ \ \ \ \ \ \ \ \ \ angle\_diff\ =\ 2\ *\ M\_PI\ -\/\ angle\_diff;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00607}00607\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00608}00608\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00609}00609\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Check\ if\ obstacle\ is\ in\ our\ travel\ path}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00610}00610\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (angle\_diff\ <=\ cone\_half\_angle)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00611}00611\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00612}00612\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Obstacle\ in\ travel\ direction\ -\/\ check\ distance}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00613}00613\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (range\ <\ 3.0)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00614}00614\ \ \ \ \ \ \ \ \ \ \ \ \ \{\ \textcolor{comment}{//\ 3m\ detection\ distance}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00615}00615\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ obstacle\_detected\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00616}00616\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ closest\_obstacle\ =\ std::min(closest\_obstacle,\ \textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{double}\textcolor{keyword}{>}(range));}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00617}00617\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00618}00618\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ RCLCPP\_DEBUG(logger\_,\ \textcolor{stringliteral}{"{}Obstacle\ in\ travel\ path:\ \%.2fm\ at\ \%.1f\ (travel\ dir:\ \%.1f)"{}},}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00619}00619\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ range,\ laser\_angle\ *\ 180.0\ /\ M\_PI,\ travel\_angle\ *\ 180.0\ /\ M\_PI);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00620}00620\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00621}00621\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00622}00622\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00623}00623\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00624}00624\ \ \ \ \ \textcolor{keywordflow}{if}\ (obstacle\_detected)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00625}00625\ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00626}00626\ \ \ \ \ \ \ \ \ RCLCPP\_WARN(logger\_,\ \textcolor{stringliteral}{"{}OBSTACLE\ IN\ TRAVEL\ PATH:\ \%.2fm\ -\/\ ascending!"{}},\ closest\_obstacle);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00627}00627\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00628}00628\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00629}00629\ \ \ \ \ \textcolor{keywordflow}{return}\ obstacle\_detected;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00630}00630\ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00631}00631\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00632}\mbox{\hyperlink{class_controller_ad9caf514c18493600e2d3efbf5fa7818}{00632}}\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{class_controller_ad9caf514c18493600e2d3efbf5fa7818}{Controller::isObstacleClearanceAchieved}}(\textcolor{keyword}{const}\ sensor\_msgs::msg::LaserScan::SharedPtr\ \&laser\_scan,}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00633}00633\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ geometry\_msgs::msg::Point\ \&current\_pos,}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00634}00634\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ geometry\_msgs::msg::Point\ \&target\_pos,}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00635}00635\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ clearance\_distance)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00636}00636\ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00637}00637\ \ \ \ \ \textcolor{keywordflow}{if}\ (!laser\_scan)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00638}00638\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00639}00639\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00640}00640\ \ \ \ \ \textcolor{comment}{//\ Calculate\ travel\ direction}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00641}00641\ \ \ \ \ \textcolor{keywordtype}{double}\ dx\ =\ target\_pos.x\ -\/\ current\_pos.x;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00642}00642\ \ \ \ \ \textcolor{keywordtype}{double}\ dy\ =\ target\_pos.y\ -\/\ current\_pos.y;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00643}00643\ \ \ \ \ \textcolor{keywordtype}{double}\ travel\_distance\ =\ std::sqrt(dx\ *\ dx\ +\ dy\ *\ dy);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00644}00644\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00645}00645\ \ \ \ \ \textcolor{keywordflow}{if}\ (travel\_distance\ <\ 0.1)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00646}00646\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00647}00647\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00648}00648\ \ \ \ \ \textcolor{keywordtype}{double}\ travel\_angle\ =\ std::atan2(dy\ /\ travel\_distance,\ dx\ /\ travel\_distance);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00649}00649\ \ \ \ \ \textcolor{keywordtype}{double}\ cone\_half\_angle\ =\ M\_PI\ /\ 4.0;\ \textcolor{comment}{//\ 45\ degrees}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00650}00650\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00651}00651\ \ \ \ \ \textcolor{comment}{//\ Check\ if\ path\ is\ clear}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00652}00652\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ laser\_scan-\/>ranges.size();\ i++)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00653}00653\ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00654}00654\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{float}\ range\ =\ laser\_scan-\/>ranges[i];}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00655}00655\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00656}00656\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (std::isnan(range)\ ||\ std::isinf(range)\ ||}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00657}00657\ \ \ \ \ \ \ \ \ \ \ \ \ range\ <=\ laser\_scan-\/>range\_min\ ||}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00658}00658\ \ \ \ \ \ \ \ \ \ \ \ \ range\ >=\ laser\_scan-\/>range\_max)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00659}00659\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00660}00660\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00661}00661\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00662}00662\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00663}00663\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{float}\ laser\_angle\ =\ laser\_scan-\/>angle\_min\ +\ (i\ *\ laser\_scan-\/>angle\_increment);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00664}00664\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ angle\_diff\ =\ std::abs(laser\_angle\ -\/\ travel\_angle);}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00665}00665\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (angle\_diff\ >\ M\_PI)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00666}00666\ \ \ \ \ \ \ \ \ \ \ \ \ angle\_diff\ =\ 2\ *\ M\_PI\ -\/\ angle\_diff;}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00667}00667\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00668}00668\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (angle\_diff\ <=\ cone\_half\_angle\ \&\&\ range\ <\ clearance\_distance)}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00669}00669\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00670}00670\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};\ \textcolor{comment}{//\ Still\ obstacles\ in\ path}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00671}00671\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00672}00672\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00673}00673\ }
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00674}00674\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};\ \textcolor{comment}{//\ Path\ is\ clear}}
\DoxyCodeLine{\Hypertarget{controller_8cpp_source_l00675}00675\ \}}

\end{DoxyCode}
