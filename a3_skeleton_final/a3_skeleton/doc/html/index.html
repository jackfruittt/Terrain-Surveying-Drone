<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.14.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PFMS Assignment 3 | 14250803: Project 1: Terrain Drone Surveying - ROS2 Autonomous Quadcopter System</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">PFMS Assignment 3 | 14250803<span id="projectnumber">&#160;1.0</span>
   </div>
   <div id="projectbrief">ROS 2 Package for Autonomous Surveying Drone</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.14.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('index.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Project 1: Terrain Drone Surveying - ROS2 Autonomous Quadcopter System </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1 class="doxsection"><a class="anchor" id="overview"></a>
Overview</h1>
<p>This project implements an autonomous quadcopter system for terrain surveying and path planning. The system utilises a quadcopter equipped with sonar and laser sensors to map rough terrain, determine traversable paths, and validate goal reachability for ground vehicle operations.</p>
<p>The quadcopter autonomously flies through provided goals, builds an elevation map using sonar data, detects obstacles with laser scanning, and determines if paths between goals are traversable based on terrain gradients.</p>
<h1 class="doxsection"><a class="anchor" id="features"></a>
Key Features</h1>
<ul>
<li><b>Autonomous Flight Control</b>: Complete takeoff, flight, and landing control</li>
<li><b>Terrain Mapping</b>: Real-time elevation mapping using sonar sensor data</li>
<li><b>Obstacle Detection</b>: 360-degree laser scanning for obstacle avoidance</li>
<li><b>Path Planning</b>: Traversability analysis based on terrain gradients</li>
<li><b>TSP Optimisation</b>: Advanced mode with Travelling Salesman Problem solving</li>
<li><b>Multi-threaded Architecture</b>: Separate threads for control and sensor processing</li>
<li><b>ROS2 Integration</b>: Full ROS2 component-based software engineering framework</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="architecture"></a>
System Architecture</h1>
<p>The system consists of two main ROS2 nodes:</p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md0"></a>
DroneNode</h3>
<ul>
<li>Main control node managing ROS related drone operations</li>
<li>Handles mission planning and execution</li>
<li>Processes goals and generates flight paths</li>
<li>Implements obstacle avoidance algorithms</li>
</ul>
<h3 class="doxsection"><a class="anchor" id="autotoc_md1"></a>
SensorNode</h3>
<ul>
<li>Dedicated sensor data processing for ROS end</li>
<li>Real-time terrain mapping using TerrainMap class</li>
<li>Laser scan processing for obstacle detection</li>
<li>Grid map generation and publishing</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="components"></a>
Core Components</h1>
<h3 class="doxsection"><a class="anchor" id="autotoc_md2"></a>
Controller Class</h3>
<ul>
<li>Handles all drone movement commands (takeoff, landing, flight)</li>
<li>Implements PID-style control for goal reaching</li>
<li>Emergency obstacle avoidance with altitude adjustment</li>
<li>Mission state management and progress tracking</li>
</ul>
<h3 class="doxsection"><a class="anchor" id="autotoc_md3"></a>
TerrainMap Class</h3>
<ul>
<li>Incremental 1Ã—1m cell-by-cell terrain mapping</li>
<li>Drone-centric grid expansion during flight</li>
<li>Gradient calculation for traversability analysis</li>
<li>High-resolution elevation data storage</li>
</ul>
<h3 class="doxsection"><a class="anchor" id="autotoc_md4"></a>
WaypointManager Class</h3>
<ul>
<li>Traversability analysis between goals</li>
<li>Waypoint generation with configurable spacing</li>
<li>Gradient-based path validation</li>
<li>Visualisation marker management</li>
</ul>
<h3 class="doxsection"><a class="anchor" id="autotoc_md5"></a>
Graph &amp; TSPSolver Classes (Advanced Mode)</h3>
<ul>
<li>Constructs traversability graphs between waypoints</li>
<li>Implements Travelling Salesman Problem solving</li>
<li>Optimises mission paths for efficiency</li>
<li>Supports complex multi-goal scenarios</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="modes"></a>
Operating Modes</h1>
<h3 class="doxsection"><a class="anchor" id="autotoc_md6"></a>
Standard Mode (Pass/Credit Level)</h3>
<ul>
<li>Sequential goal processing</li>
<li>Direct path traversability checking</li>
<li>Basic terrain mapping and analysis</li>
<li>Gradient-based goal validation</li>
</ul>
<h3 class="doxsection"><a class="anchor" id="autotoc_md7"></a>
Advanced Mode (Distinction/High Distinction Level)</h3>
<ul>
<li>TSP-optimised path planning</li>
<li>Complex traversability graph construction</li>
<li>Multiple valid path analysis</li>
<li>Advanced visualisation of all possible routes</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="topics"></a>
ROS2 Topics Interface</h1>
<h3 class="doxsection"><a class="anchor" id="autotoc_md8"></a>
Subscribed Topics</h3>
<ul>
<li><span class="tt">/drone/gt_odom</span> - Robot odometry data</li>
<li><span class="tt">/drone/laserscan</span> - 360-degree laser scan data</li>
<li><span class="tt">/drone/sonar</span> - Ground distance measurements</li>
<li><span class="tt">/mission/goals</span> - Goal positions for surveying</li>
</ul>
<h3 class="doxsection"><a class="anchor" id="autotoc_md9"></a>
Published Topics</h3>
<ul>
<li><span class="tt">/drone/cmd_vel</span> - Velocity commands for drone control</li>
<li><span class="tt">/drone/takeoff</span> - Takeoff command</li>
<li><span class="tt">/drone/landing</span> - Landing command</li>
<li><span class="tt">/grid_map</span> - Real-time elevation map</li>
<li><span class="tt">/mission/path</span> - Traversable waypoints between goals</li>
<li><span class="tt">/visualisation_marker</span> - RViz visualisation markers</li>
</ul>
<h3 class="doxsection"><a class="anchor" id="autotoc_md10"></a>
Services</h3>
<ul>
<li><span class="tt">/mission/control</span> - Start/stop mission control service</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="algorithms"></a>
Key Algorithms</h1>
<h3 class="doxsection"><a class="anchor" id="autotoc_md11"></a>
Terrain Mapping Algorithm</h3>
<ol type="1">
<li>Process sonar readings at current drone position</li>
<li>Update elevation map with new height data</li>
<li>Calculate gradients around updated regions</li>
<li>Expand map boundaries as drone moves</li>
<li>Maintain high-resolution terrain representation</li>
</ol>
<h3 class="doxsection"><a class="anchor" id="autotoc_md12"></a>
Obstacle Avoidance Algorithm</h3>
<ol type="1">
<li>Continuously monitor 360-degree laser scans</li>
<li>Detect obstacles within minimum safe distance (3m)</li>
<li>Execute emergency altitude increase when needed</li>
<li>Resume normal flight when obstacles cleared</li>
<li>Maintain altitude control using sonar feedback</li>
</ol>
<h3 class="doxsection"><a class="anchor" id="autotoc_md13"></a>
Traversability Analysis Algorithm</h3>
<ol type="1">
<li>Calculate terrain gradients between waypoints</li>
<li>Compare gradients against maximum threshold (3% default)</li>
<li>Generate intermediate waypoints at 1m intervals</li>
<li>Validate entire path for ground vehicle access</li>
<li>Abort mission if any segment non-traversable</li>
</ol>
<h3 class="doxsection"><a class="anchor" id="autotoc_md14"></a>
TSP Optimisation Algorithm (Advanced Mode)</h3>
<ol type="1">
<li>Build complete traversability graph between all goals</li>
<li>Calculate costs for all valid path segments</li>
<li>Apply TSP solver to find optimal visiting order</li>
<li>Generate optimised mission sequence</li>
<li>Visualise all valid paths and highlight optimal route</li>
</ol>
<h1 class="doxsection"><a class="anchor" id="parameters"></a>
Configuration Parameters</h1>
<ul>
<li><span class="tt">road_gradient</span> - Maximum traversable gradient (default: 3%)</li>
<li><span class="tt">advanced</span> - Enable advanced TSP mode (default: false)</li>
<li>Various control parameters for PID tuning and safety margins</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="threading"></a>
Thread Safety</h1>
<p>The system implements comprehensive thread safety using:</p><ul>
<li>Mutex protection for shared sensor data</li>
<li>Atomic variables for mission state tracking</li>
<li>Condition variables for thread coordination</li>
<li>Lock-free communication where possible</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="testing"></a>
Unit Testing</h1>
<p>Comprehensive unit tests cover:</p><ul>
<li>Grid map creation and elevation mapping</li>
<li>Goal traversability detection algorithms</li>
<li>TSP solving with known optimal solutions</li>
<li>Sensor data processing accuracy</li>
<li>Controller response validation</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="usage"></a>
Usage Instructions</h1>
<p>README** On my local setup I have aliases setup as shown below which some images may show. However, the instructions provided onwards are non-alias based commands which can be run in substitution to my aliases. I also have shell scripts for publishing.</p>
<div style="margin-bottom: 30px;"> <div class="image">
<img src="alias.png" alt=""/>
<div class="caption">
Alias setup</div></div>
 </div><ol type="1">
<li><b>Launch the RVIZ gui:</b> <div class="fragment"><div class="line">ros2 launch pfms a3_terrain.launch.py</div>
</div><!-- fragment --></li>
</ol>
<div style="margin-bottom: 30px;"> <div class="image">
<img src="drone_gui.png" alt=""/>
<div class="caption">
Drone GUI</div></div>
 </div><ol type="1">
<li><b>Launch drone node:</b> <div class="fragment"><div class="line">cd ~/ros2_ws/</div>
<div class="line">ros2 run a3_skeleton drone_node</div>
</div><!-- fragment --> This will start both the controller and drone node</li>
</ol>
<div style="margin-bottom: 30px;"> <div class="image">
<img src="start_node.png" alt=""/>
<div class="caption">
Nodes Started</div></div>
 </div><ol type="1">
<li><b>For advanced mode:</b> <div class="fragment"><div class="line">ros2 run a3_skeleton drone_node advanced:=<span class="keyword">true</span></div>
</div><!-- fragment --></li>
<li><b>Send goals in a separate terminal:</b> <div class="fragment"><div class="line">ros2 topic pub /mission/goals geometry_msgs/msg/PoseArray <span class="stringliteral">&#39;{poses: [...]}&#39;</span></div>
</div><!-- fragment --></li>
</ol>
<div style="margin-bottom: 30px;"> <div class="image">
<img src="send_goals.png" alt=""/>
<div class="caption">
Goals Published</div></div>
 </div><p>These goals can be in JSON or YAML format. Goals also do not need a Z-coordinate because of altitude control. If you publish a goal with Z &gt; 2 altitude control will be overridden.</p>
<ol type="1">
<li><b>Start mission in separate terminal:</b> <div class="fragment"><div class="line">ros2 service call /mission/control std_srvs/srv/SetBool <span class="stringliteral">&#39;{data: true}&#39;</span></div>
</div><!-- fragment --></li>
</ol>
<div style="margin-bottom: 30px;"> <div class="image">
<img src="Service_true.png" alt=""/>
<div class="caption">
Service True</div></div>
 </div><ol type="1">
<li><b>To pause/stop mission</b> <div class="fragment"><div class="line">ros2 service call /mission/control std_srvs/srv/SetBool <span class="stringliteral">&#39;data: false}&#39;</span></div>
</div><!-- fragment --></li>
</ol>
<p>For stop mission the drone will traverse to its current goal then stop. It will not stop straight away. </p>
<h1 class="doxsection"><a class="anchor" id="testing_process"></a>
Testing Process</h1>
<p>Various scripts have been developed to assist in testing drone code and functionality. These scripts can be found in the scripts directory of the package. In the test directory is drone_survey_tests.cpp which covers all tests. A custom rosbag recorder to record topics specific to task 1. Test bags I used have been deleted to reduce package size however, these can be recreated by running the data collector and the test can be executed as follows:</p>
<ol type="1">
<li><b>Launch drone terrain and start drone node:</b> <br  />
 <div class="fragment"><div class="line">ros2 launch pfms a3_terrain.launch.py</div>
</div><!-- fragment --> In another terminal: <div class="fragment"><div class="line">cd ~/ros2_ws/</div>
<div class="line">ros2 run a3_skeleton drone_node</div>
</div><!-- fragment --></li>
<li><b>Run Data collector script (from ros2_ws):</b> <div class="fragment"><div class="line">./src/a3_skeleton/scripts/collect_test_data.sh collect</div>
</div><!-- fragment --></li>
</ol>
<div style="margin-bottom: 30px;"> <div class="image">
<img src="data_collect.png" alt=""/>
<div class="caption">
Data Collector Running (Bottom Right Terminal)</div></div>
 </div><div style="margin-bottom: 30px;"> <div class="image">
<img src="bag_data.png" alt=""/>
<div class="caption">
Directory Created after data collection with bags stored</div></div>
 </div><p>Internally this script will publish goals and start the service for drone navigation. It is a 3 part process in which the ros record will record and stop three times to record three different bags. One for the gridmap test, traversability and TSP. The script will keep running and stop once all bags have been recorded. Note: that goals for each bag is different or similar. The bags will be stored in a directory called test_data (removed from my submission) but the collector script will make it. If you ever wish to make new bags it will delete the old bags and replace with the new if the script is run again.</p>
<ol type="1">
<li><b>Run test script:</b> For whatever reason <div class="fragment"><div class="line">colcon test --packages-select a3_skeleton </div>
</div><!-- fragment --> doesn't work. To run the test file <div class="fragment"><div class="line">cd ~/ros2_ws/build/a3_skeleton </div>
</div><!-- fragment --> (if package isn't built, build it first) And then: <div class="fragment"><div class="line">./drone_survey_tests</div>
</div><!-- fragment --></li>
</ol>
<p>If the test successfully runs you will see the following output: </p><div style="margin-bottom: 30px;"> <div class="image">
<img src="test_pass.png" alt=""/>
<div class="caption">
tests run and passed</div></div>
 </div><p>Note:** The test script has hard coded paths due to universal pathing options causing issues, resulting in tests being skipped. To overcome this make sure to adjust the paths on lines 124, 214 and 308 of the drone_survey_tests.cpp</p>
<h1 class="doxsection"><a class="anchor" id="visualisation"></a>
Visualisation</h1>
<p>The system provides rich visualisation through RViz:</p><ul>
<li>Real-time elevation map display</li>
<li>Traversable waypoint markers (green cylinders)</li>
<li>Non-traversable path indicators (red markers)</li>
<li>Drone position and orientation tracking</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="safety"></a>
Safety Features</h1>
<ul>
<li>Emergency obstacle avoidance with immediate altitude increase (not functional)</li>
<li>Mission abort capability for non-traversable terrain</li>
<li>Safe return-to-origin functionality</li>
<li>Altitude control with sonar-based ground clearance</li>
<li>Comprehensive error handling and recovery</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="implementation"></a>
Implementation Details</h1>
<h3 class="doxsection"><a class="anchor" id="autotoc_md15"></a>
Controller Threaded Design</h3>
<p>The system employs a threaded architecture for the controller:</p><ul>
<li><b>Main Controller Thread</b>: Handles drone control functionality. In theory multiple drones can be controlled and have independent missions.</li>
</ul>
<h3 class="doxsection"><a class="anchor" id="autotoc_md16"></a>
Data Structures</h3>
<ul>
<li>STL containers for efficient waypoint storage and manipulation</li>
<li>Thread-safe queues for inter-thread communication</li>
<li>Grid-based elevation maps with dynamic expansion</li>
<li>Graph structures for TSP path optimisation</li>
</ul>
<h3 class="doxsection"><a class="anchor" id="autotoc_md17"></a>
Error Handling</h3>
<ul>
<li>Graceful degradation when goals are unreachable</li>
<li>Automatic return-to-home on mission failure</li>
<li>Comprehensive logging for debugging and analysis</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="performance"></a>
Performance Considerations</h1>
<ul>
<li>Real-time constraint compliance for safety-critical operations</li>
<li>Efficient memory management for large terrain maps</li>
<li>Optimised algorithms for rapid obstacle detection</li>
<li>Scalable TSP solving for varying numbers of goals</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="authors"></a>
Authors</h1>
<p>Jackson Russell</p>
<dl class="section date"><dt>Date</dt><dd>June 2025 </dd></dl>
<dl class="section version"><dt>Version</dt><dd>1.0 </dd></dl>
</div></div><!-- PageDoc -->
<a href="doxygen_crawl.html"></a>
</div><!-- contents -->
</div><!-- doc-content -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.14.0 </li>
  </ul>
</div>
</body>
</html>
